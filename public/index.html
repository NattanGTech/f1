<!-- index.html -->
<HTML>
    <HEAD>
        <SCRIPT src="https://cdn.3dverse.com/legacy/sdk/latest/SDK3DVerse.js"></SCRIPT>
        <SCRIPT src="https://cdn.3dverse.com/legacy/sdk/latest/SDK3DVerse_Gizmos_Ext.js"></SCRIPT>
        <SCRIPT src="https://cdn.3dverse.com/legacy/sdk/latest/SDK3DVerse_ThreeJS_Ext.js"></SCRIPT>
        <SCRIPT src="https://cdn.3dverse.com/legacy/sdk/latest/SDK3DVerse_ViewportDomOverlay_Ext.js"></SCRIPT>
        <SCRIPT src="https://cdn.3dverse.com/legacy/sdk/latest/SDK3DVerse_SplineDisplay_Ext.js"></SCRIPT>
        <SCRIPT src="./AppConfig.js"></SCRIPT>

        <SCRIPT>
            window.addEventListener('load', async () =>
            {
                var canvas = document.getElementById('display_canvas');
                const connectionInfo = await SDK3DVerse.webAPI.createOrJoinSession(AppConfig.sceneUUID);

                SDK3DVerse.notifier.on('onLoadingStarted', () => document.getElementById("message").innerHTML = "Connecting...");
                SDK3DVerse.notifier.on('onLoadingProgress', (status) => document.getElementById("message").innerHTML = status.message);
                SDK3DVerse.notifier.on('onLoadingEnded', (status) => document.getElementById("message").innerHTML = status.message);

                SDK3DVerse.setupDisplay(canvas);
                SDK3DVerse.startStreamer(connectionInfo);

                SDK3DVerse.installExtension(SDK3DVerse_SplineDisplay_Ext);
                SDK3DVerse.connectToEditor();

                function GameLoop() { 
                    window.requestAnimationFrame(function() {
                        voiture.setPosition(allpositions[i]);
                        i++;
                        SDK3DVerse.engineAPI.propagateChanges();
                        GameLoop();
                    });
                }

                canvas.addEventListener(
                    'mouseup',
                    async (e) =>
                    {
                        var spline = await SDK3DVerse.engineAPI.findEntitiesByEUID("3bb55065-4c5a-4507-8ba6-1d80a9df1f0c");
                        var voiture = await SDK3DVerse.engineAPI.findEntitiesByEUID("1f9c1d9a-338d-4eaf-8adb-02d21653befb");
                        console.log('Spline: ', spline);
                        console.log('Voiture: ', voiture);

                        var trajEntities = spline[0];
                        var allpoints = SDK3DVerse.engineAPI.getEntityChildren(trajEntities);
                        console.log('debug children: ', SDK3DVerse.engineAPI.getEntityChildren(trajEntities));

                        var allpositions = new Array();
                        for(const point of allpoints){
                            allpositions.push(point.getGlobalTransform());
                        }
                        console.log('Position: ', allpositions);
                        // GameLoop();
                    },
                    false
                );
            }); 
        </SCRIPT>
    </HEAD>

    <BODY>
        <DIV id="message">Loading...</DIV>
        <CANVAS tabindex="1" id="display_canvas" width="1280" height="720"></CANVAS>
    </BODY>
</HTML>